<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	  th:replace="~{base::layout(~{::section})}">
<head>
	<meta charset="UTF-8">
	<title>Shopping Cart</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<style>
		.options-column label { margin-right: 15px; font-size: 0.9em; white-space: nowrap; }
		.options-column input[type="checkbox"] { margin-right: 5px; vertical-align: middle; cursor: pointer; }
		.options-cell { min-width: 180px; text-align: left; padding-left: 15px !important; }
		.quantity-cell { text-align: center; }
		.price-cell { text-align: center; }
		.item-total-price-cell { text-align: center; font-weight: bold; }
		.cart-item-row {}
		.item-decorated-price {}
		.grand-total-price {}

		.spinner-border-sm { width: 1rem; height: 1rem; border-width: .2em; }
		.price-loading { display: inline-block; margin-left: 5px; }
	</style>
</head>
<body>
<section>
	<div class="container-fluid mt-5 p-5">
		<div class="card shadow-lg">
			<div class="card-header text-center"><h3 class="mb-0">My Shopping Cart</h3></div>
			<div class="card-body">
				<div id="cart-message" class="text-center mb-3"></div>
				<th:block th:if="${session.succMsg}"><p class="text-success fw-bold text-center">[[${session.succMsg}]]</p><th:block th:text="${@commnServiceImpl.removeSessionMessage()}"></th:block></th:block>
				<th:block th:if="${session.errorMsg}"><p class="text-danger fw-bold text-center">[[${session.errorMsg}]]</p><th:block th:text="${@commnServiceImpl.removeSessionMessage()}"></th:block></th:block>

				<div class="table-responsive">
					<table class="table table-bordered table-hover align-middle">
						<thead class="table-dark text-center">
						<tr>
							<th>Sl No</th>
							<th>Image</th>
							<th>Product Name</th>
							<th>Unit Price</th>
							<th>Quantity</th>
							<th>Options</th>
							<th>Item Total</th>
						</tr>
						</thead>
						<tbody>
						<tr th:if="${#lists.isEmpty(carts)}"><td colspan="7" class="text-center text-muted fst-italic py-4">Your shopping cart is empty.</td></tr>
						<tr th:each="cart,c:${carts}" th:if="${not #lists.isEmpty(carts)}" class="cart-item-row" th:data-cart-id="${cart.id}">
							<th scope="row" class="text-center">[[${c.count}]]</th>
							<td class="text-center"><img th:src="@{'/img/product_img/'+${cart.product.image}}" width="70" height="70" class="product-img"></td>
							<td>[[${cart.product.title}]]</td>
							<td class="price-cell">[[${#numbers.formatCurrency(cart.product.discountPrice)}]]</td>
							<td class="quantity-cell">
								<div class="quantity-control">
									<a th:href="@{'/user/cartQuantityUpdate?sy=de&cid='+${cart.id}}"><i class="fa-solid fa-minus"></i></a>
									<span class="mx-2">[[${cart.quantity}]]</span>
									<a th:href="@{'/user/cartQuantityUpdate?sy=in&cid='+${cart.id}}"><i class="fa-solid fa-plus"></i></a>
								</div>
							</td>
							<td class="options-cell">
								<div class="options-column">
									<label>
										<input type="checkbox" class="cart-option-cb" th:checked="${cart.wantsGiftWrap}" onchange="updateCartOption(this)" th:data-cart-id="${cart.id}" data-option-type="giftWrap">
										Gói quà (+50k)
									</label>
									<br>
									<label>
										<input type="checkbox" class="cart-option-cb" th:checked="${cart.wantsInsurance}" onchange="updateCartOption(this)" th:data-cart-id="${cart.id}" data-option-type="insurance">
										Bảo hiểm (+1%)
									</label>
								</div>
							</td>
							<td class="item-total-price-cell item-decorated-price">
								[[${#numbers.formatCurrency(cart.decoratedPrice)}]]
								<span class="price-loading spinner-border spinner-border-sm text-info" style="display: none;"></span> <!-- Spinner -->
							</td>
						</tr>

						<tr class="total-price-row text-center" th:if="${not #lists.isEmpty(carts)}">
							<td colspan="6" style="font-weight: bold;">Grand Total</td>
							<td style="font-weight: bold;" class="grand-total-price">
								[[${#numbers.formatCurrency(totalOrderPrice)}]]
								<span class="price-loading spinner-border spinner-border-sm text-info" style="display: none;"></span> <!-- Spinner -->
							</td>
						</tr>
						</tbody>
					</table>
				</div>

				<div class="text-center mt-4" th:if="${not #lists.isEmpty(carts)}"><a th:href="@{/user/orders}" class="btn proceed-btn">Proceed to Checkout <i class="fa-solid fa-credit-card ms-2"></i></a></div>
				<div class="text-center mt-4" th:if="${#lists.isEmpty(carts)}"><a th:href="@{/products}" class="btn btn-primary">Continue Shopping</a></div>
			</div>
		</div>
	</div>

	<script>
		function formatCurrency(value) {
			if (isNaN(value)) return 'N/A';
			return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);
		}

		function showLoading(cartId, show = true) {
			const row = document.querySelector(`.cart-item-row[data-cart-id='${cartId}']`);
			const itemPriceSpinner = row ? row.querySelector('.item-decorated-price .price-loading') : null;
			const grandTotalSpinner = document.querySelector('.grand-total-price .price-loading');

			if (itemPriceSpinner) itemPriceSpinner.style.display = show ? 'inline-block' : 'none';
			if (grandTotalSpinner) grandTotalSpinner.style.display = show ? 'inline-block' : 'none'; // Hiển thị spinner ở cả 2 chỗ
		}

		function showMessage(message, isError = false) {
			const messageDiv = document.getElementById('cart-message');
			if (messageDiv) {
				messageDiv.textContent = message;
				messageDiv.className = isError ? 'text-danger fw-bold text-center mb-3' : 'text-success fw-bold text-center mb-3';
				setTimeout(() => { messageDiv.textContent = ''; }, 5000);
			}
		}

		// cập nhật tùy chọn
		function updateCartOption(checkbox) {
			const cartId = checkbox.dataset.cartId;
			const optionType = checkbox.dataset.optionType;
			const isChecked = checkbox.checked;
			const url = '/user/cart/updateOption';

			checkbox.disabled = true;
			showLoading(cartId, true);
			showMessage('');

			const formData = new URLSearchParams();
			formData.append('cartId', cartId);
			formData.append('optionType', optionType);
			formData.append('isChecked', isChecked);

			fetch(url, {
				method: 'PUT',
				headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
				body: formData
			})
					.then(response => {
						if (!response.ok) {
							return response.json().then(err => { throw new Error(err.error || `HTTP error! Status: ${response.status}`) });
						}
						return response.json();
					})
					.then(data => {
						if (data.success) {
							console.log('Success:', data);
							showMessage('Cart option updated successfully!', false);

							// Cập nhật giá item
							const itemPriceCell = document.querySelector(`.cart-item-row[data-cart-id='${cartId}'] .item-decorated-price`);
							if (itemPriceCell) {
								const spinner = itemPriceCell.querySelector('.price-loading');
								if (spinner) spinner.remove();
								itemPriceCell.textContent = formatCurrency(data.newItemPrice);
								itemPriceCell.appendChild(spinner);
							}

							// Cập nhật tổng giá
							const grandTotalCell = document.querySelector('.grand-total-price');
							if (grandTotalCell) {
								const spinner = grandTotalCell.querySelector('.price-loading');
								if (spinner) spinner.remove();
								grandTotalCell.textContent = formatCurrency(data.newTotalPrice);
								grandTotalCell.appendChild(spinner);
							}

						} else {
							throw new Error(data.message || 'Update failed on server.');
						}
					})
					.catch((error) => {
						console.error('Error:', error);
						showMessage('Error updating cart: ' + error.message, true);
						checkbox.checked = !isChecked;
					})
					.finally(() => {
						checkbox.disabled = false;
						showLoading(cartId, false);
					});
		}
	</script>
</section>
</body>
</html>